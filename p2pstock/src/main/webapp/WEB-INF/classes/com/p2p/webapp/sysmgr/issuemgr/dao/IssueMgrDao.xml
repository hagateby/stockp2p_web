<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.p2p.webapp.sysmgr.issuemgr.dao.IssueMgrDao">
	
	<!-- 查询发行产品列表 -->
	<select id="selectInvestProductlist" parameterType="Map" resultType="InvestProduct">
			SELECT 	
				T1.INVT_PRODUCT_ID,T1.USER_ID,T1.INVT_PRODUCT_NAME,T1.RISK_LVL,T1.INVT_PRODUCT_STATUS,
				(SELECT PARA_NAME FROM T_SYSTEM_PARA WHERE PARA_VALUES = T1.INVT_PRODUCT_STATUS AND PARA_TYPE = 'INVESTPRTSTATUS') AS INVT_PRODUCT_STATUSNAME,
				T1.START_DATE AS INVESTSTART_DATE,T1.END_DATE AS INVESTEND_DATE,T1.AMOUNT,T1.PROTOL_ID,T1.ISSUE_FEE,T2.PHONE AS USER_NAME,
				T3.INVEST_PRDOUCT_ID AS FLAG
			FROM
				T_INVEST_PRDOUCT T1 
				LEFT JOIN T_USER T2 ON T1.USER_ID = T2.USER_ID
				LEFT JOIN (SELECT DISTINCT INVEST_PRDOUCT_ID FROM T_INVEST )T3 ON T3.INVEST_PRDOUCT_ID = T1.INVT_PRODUCT_ID
			WHERE 	1 = 1 AND T1.IS_DEL = '0'
			<if test="invt_product_name != null and invt_product_name != ''">
				AND T1.invt_product_name LIKE #{invt_product_namelike}
			</if>
			<if test="user_id != null and user_id != ''">
				AND T1.USER_ID = #{user_id}
			</if>
			<if test="start_date != null and start_date != ''">
				AND STR_TO_DATE(T1.START_DATE,'%Y-%m-%d')  &gt;= #{start_date}
			</if>
			<if test="end_date != null and end_date != ''">
				AND STR_TO_DATE(T1.END_DATE,'%Y-%m-%d')   &lt;= #{end_date}
			</if>
			<if test="invt_product_status != null and invt_product_status != ''">
				AND T1.INVT_PRODUCT_STATUS = #{invt_product_status}
			</if>
			ORDER BY T1.UPDATE_DATE DESC
	</select>
	<!-- 查询可投资产品列表 -->
	<select id="selectActiveProductlist" resultType="InvestProduct">
			SELECT 	T1.INVT_PRODUCT_ID,T1.USER_ID,T1.INVT_PRODUCT_NAME,T1.RISK_LVL,T1.INVT_PRODUCT_STATUS,
					(SELECT PARA_NAME FROM T_SYSTEM_PARA WHERE PARA_VALUES = T1.INVT_PRODUCT_STATUS AND PARA_TYPE = 'INVESTPRTSTATUS') AS INVT_PRODUCT_STATUSNAME,
					T1.START_DATE AS INVESTSTART_DATE,T1.END_DATE AS INVESTEND_DATE,T1.AMOUNT,T1.PROTOL_ID,T1.ISSUE_FEE,T2.PHONE AS USER_NAME
			FROM    T_INVEST_PRDOUCT T1 LEFT JOIN T_USER T2
			ON T1.USER_ID = T2.USER_ID
			WHERE 	1 = 1 AND T1.IS_DEL = '0' AND STR_TO_DATE(T1.END_DATE,'%Y-%m-%d') &gt;= STR_TO_DATE(NOW(),'%Y-%m-%d') AND T1.INVT_PRODUCT_STATUS = '0'
			ORDER BY T1.UPDATE_DATE DESC
	</select>
	<!-- 查询历史投资产品列表 -->
	<select id="selectHisProductlist" resultType="InvestProduct">
			SELECT 	T1.INVT_PRODUCT_ID,T1.USER_ID,T1.INVT_PRODUCT_NAME,T1.RISK_LVL,T1.INVT_PRODUCT_STATUS,
					(SELECT PARA_NAME FROM T_SYSTEM_PARA WHERE PARA_VALUES = T1.INVT_PRODUCT_STATUS AND PARA_TYPE = 'INVESTPRTSTATUS') AS INVT_PRODUCT_STATUSNAME,
					T1.START_DATE AS INVESTSTART_DATE,T1.END_DATE AS INVESTEND_DATE,T1.AMOUNT,T1.PROTOL_ID,T1.ISSUE_FEE,T2.PHONE AS USER_NAME
			FROM    T_INVEST_PRDOUCT T1 LEFT JOIN T_USER T2
			ON T1.USER_ID = T2.USER_ID
			WHERE
			 1 = 1 AND T1.IS_DEL = '0' AND (STR_TO_DATE(T1.END_DATE,'%Y-%m-%d %H:%i') &lt;= NOW()
			 OR (T1.INVT_PRODUCT_STATUS = '2' or T1.INVT_PRODUCT_STATUS = '3' or T1.INVT_PRODUCT_STATUS = '4' or T1.INVT_PRODUCT_STATUS = '5'))
			ORDER BY T1.UPDATE_DATE DESC
	</select>
	<!-- 查询投资产品详细信息 -->
	<select id="selectInvestMoreInfo" parameterType="string" resultType="InvestMoreInfo">
			SELECT
				T1.INVT_PRODUCT_ID,T4.BASIC_PRODUCT_ID,T2.BASIC_PRODUCT_NAME,T2.BASIC_PRODUCT_TYPE,
				(SELECT PARA_NAME FROM T_SYSTEM_PARA WHERE PARA_VALUES = T2.BASIC_PRODUCT_TYPE AND PARA_TYPE = 'PROTYP') AS BASIC_PRODUCT_TYPENAME,
				T1.STARTER_BAIL,T1.INVESTER_BAIL,T1.LAUNCHER_ACCRUEDCHARGES_TYPE,
				(SELECT PARA_NAME FROM T_SYSTEM_PARA WHERE PARA_VALUES = T1.LAUNCHER_ACCRUEDCHARGES_TYPE AND PARA_TYPE = 'ACCCHARGETYP') AS LAUNCHER_ACCRUEDCHARGES_TYPENAME,
				T1.LAUNCHER_ACCRUEDCHARGES_AMOUNT,T1.USER_ACCRUEDCHARGES_TYPE,
				(SELECT PARA_NAME FROM T_SYSTEM_PARA WHERE PARA_VALUES = T1.USER_ACCRUEDCHARGES_TYPE AND PARA_TYPE = 'ACCCHARGETYP') AS USER_ACCRUEDCHARGES_TYPENAME,
				T1.USER_ACCRUEDCHARGES_AMOUNT,T3.BASIC_PRODUCT_STOCK_ID,T3.INVEST_PRODUCT_ID,T3.SALES_CITY,T3.LOT_DATE,
				(SELECT PARA_NAME FROM T_SYSTEM_PARA WHERE PARA_VALUES = T3.SALES_CITY AND PARA_TYPE = 'CITY') AS SALES_CITYNAME,
				T3.PRICE,T3.START_DATE,T3.END_DATE,T3.UP_LIMIT,T3.LOW_LIMIT,T1.AMOUNT,T1.ISSUE_FEE,T1.INVT_PRODUCT_NAME,T1.INVT_PRODUCT_STATUS,T5.PHONE AS USER_NAME,
				T3.RESULT_FLAG,T3.RESULT_NO,T1.START_DATE AS INVESTSTART_DATE,T1.END_DATE AS INVESTEND_DATE
			FROM T_INVEST_PRDOUCT T1
			LEFT JOIN T_INVEST_BASE T4
			ON T1.INVT_PRODUCT_ID = T4.INVT_PRODUCT_ID 
			LEFT JOIN T_BASIC_PRODUCT T2 
			ON T4.BASIC_PRODUCT_ID = T2.BASIC_PRODUCT_ID 
			LEFT JOIN T_BASIC_PRODUCT_STOCK T3
			ON T4.BASIC_PRODUCT_ID = T3.BASIC_PRODUCT_ID
			LEFT JOIN T_USER T5
			ON T1.USER_ID =  T5.USER_ID
			WHERE T1.INVT_PRODUCT_ID = #{invest_product_id}
	</select>
	<!-- 查询投资产品、基础标的查询详细信息 -->
	<select id="selectInvestMoreInfoByib" parameterType="string" resultType="InvestMoreInfo">
			SELECT
				T0.USER_ID,T0.USER_INVEST_ID,T6.ACOUNT_PRTFEE,T6.ACOUNT_BAIL,T6.AMOUNT AS AMOUNT_ALL,
				T1.INVT_PRODUCT_ID,T4.BASIC_PRODUCT_ID,T2.BASIC_PRODUCT_NAME,T2.BASIC_PRODUCT_TYPE,
				(SELECT PARA_NAME FROM T_SYSTEM_PARA WHERE PARA_VALUES = T2.BASIC_PRODUCT_TYPE AND PARA_TYPE = 'PROTYP') AS BASIC_PRODUCT_TYPENAME,
				T1.STARTER_BAIL,T1.INVESTER_BAIL,T1.LAUNCHER_ACCRUEDCHARGES_TYPE,
				(SELECT PARA_NAME FROM T_SYSTEM_PARA WHERE PARA_VALUES = T1.LAUNCHER_ACCRUEDCHARGES_TYPE AND PARA_TYPE = 'ACCCHARGETYP') AS LAUNCHER_ACCRUEDCHARGES_TYPENAME,
				T1.LAUNCHER_ACCRUEDCHARGES_AMOUNT,T1.USER_ACCRUEDCHARGES_TYPE,
				(SELECT PARA_NAME FROM T_SYSTEM_PARA WHERE PARA_VALUES = T1.USER_ACCRUEDCHARGES_TYPE AND PARA_TYPE = 'ACCCHARGETYP') AS USER_ACCRUEDCHARGES_TYPENAME,
				T1.USER_ACCRUEDCHARGES_AMOUNT,T3.BASIC_PRODUCT_STOCK_ID,T3.INVEST_PRODUCT_ID,T3.SALES_CITY,
				(SELECT PARA_NAME FROM T_SYSTEM_PARA WHERE PARA_VALUES = T3.SALES_CITY AND PARA_TYPE = 'CITY') AS SALES_CITYNAME,
				T3.PRICE,T3.START_DATE,T3.END_DATE,T3.UP_LIMIT,T3.LOW_LIMIT,T1.AMOUNT,T1.ISSUE_FEE,T1.INVT_PRODUCT_NAME,T1.INVT_PRODUCT_STATUS,T5.PHONE AS USER_NAME,
				T3.RESULT_FLAG,T3.RESULT_NO,T1.START_DATE AS INVESTSTART_DATE,T1.END_DATE AS INVESTEND_DATE,T6.DETAIL_ID
			FROM T_INVEST T0 LEFT JOIN
				T_INVEST_DETAIL T6
				ON T0.USER_INVEST_ID = T6.USER_INVEST_ID LEFT JOIN
				T_INVEST_PRDOUCT T1
				ON T6.INVEST_PRDOUCT_ID = T1.INVT_PRODUCT_ID
				LEFT JOIN T_INVEST_BASE T4
				ON T1.INVT_PRODUCT_ID = T4.INVT_PRODUCT_ID AND T6.BASIC_PRODUCT_ID = T4.BASIC_PRODUCT_ID
				LEFT JOIN T_BASIC_PRODUCT T2 
				ON T4.BASIC_PRODUCT_ID = T2.BASIC_PRODUCT_ID 
				LEFT JOIN T_BASIC_PRODUCT_STOCK T3
				ON T4.BASIC_PRODUCT_ID = T3.BASIC_PRODUCT_ID
				LEFT JOIN T_USER T5
				ON T1.USER_ID =  T5.USER_ID
			WHERE T1.INVT_PRODUCT_ID = #{invest_product_id} AND T4.BASIC_PRODUCT_ID = #{basic_product_id}
			<if test="invest_status != null and invest_status != ''">
				AND T6.INVEST_STATUS = #{invest_status} 
			</if>
	</select>
	<!-- 查询投资产品、基础标的查询详细信息(待结算) -->
	<select id="selectInvestMoreInfoByibSetl" parameterType="string" resultType="InvestMoreInfo">
			SELECT
				T0.USER_ID,T0.USER_INVEST_ID,T6.ACOUNT_PRTFEE,T6.ACOUNT_BAIL,T6.AMOUNT AS AMOUNT_ALL,
				T1.INVT_PRODUCT_ID,T4.BASIC_PRODUCT_ID,T2.BASIC_PRODUCT_NAME,T2.BASIC_PRODUCT_TYPE,
				(SELECT PARA_NAME FROM T_SYSTEM_PARA WHERE PARA_VALUES = T2.BASIC_PRODUCT_TYPE AND PARA_TYPE = 'PROTYP') AS BASIC_PRODUCT_TYPENAME,
				T1.STARTER_BAIL,T1.INVESTER_BAIL,T1.LAUNCHER_ACCRUEDCHARGES_TYPE,
				(SELECT PARA_NAME FROM T_SYSTEM_PARA WHERE PARA_VALUES = T1.LAUNCHER_ACCRUEDCHARGES_TYPE AND PARA_TYPE = 'ACCCHARGETYP') AS LAUNCHER_ACCRUEDCHARGES_TYPENAME,
				T1.LAUNCHER_ACCRUEDCHARGES_AMOUNT,T1.USER_ACCRUEDCHARGES_TYPE,
				(SELECT PARA_NAME FROM T_SYSTEM_PARA WHERE PARA_VALUES = T1.USER_ACCRUEDCHARGES_TYPE AND PARA_TYPE = 'ACCCHARGETYP') AS USER_ACCRUEDCHARGES_TYPENAME,
				T1.USER_ACCRUEDCHARGES_AMOUNT,T3.BASIC_PRODUCT_STOCK_ID,T3.INVEST_PRODUCT_ID,T3.SALES_CITY,
				(SELECT PARA_NAME FROM T_SYSTEM_PARA WHERE PARA_VALUES = T3.SALES_CITY AND PARA_TYPE = 'CITY') AS SALES_CITYNAME,
				T3.PRICE,T3.START_DATE,T3.END_DATE,T3.UP_LIMIT,T3.LOW_LIMIT,T1.AMOUNT,T1.ISSUE_FEE,T1.INVT_PRODUCT_NAME,T1.INVT_PRODUCT_STATUS,T5.PHONE AS USER_NAME,
				T3.RESULT_FLAG,T3.RESULT_NO,T1.START_DATE AS INVESTSTART_DATE,T1.END_DATE AS INVESTEND_DATE,T6.DETAIL_ID
			FROM T_INVEST T0 LEFT JOIN
				T_INVEST_DETAIL T6
				ON T0.USER_INVEST_ID = T6.USER_INVEST_ID LEFT JOIN
				T_INVEST_PRDOUCT T1
				ON T6.INVEST_PRDOUCT_ID = T1.INVT_PRODUCT_ID
				LEFT JOIN T_INVEST_BASE T4
				ON T1.INVT_PRODUCT_ID = T4.INVT_PRODUCT_ID AND T6.BASIC_PRODUCT_ID = T4.BASIC_PRODUCT_ID
				LEFT JOIN T_BASIC_PRODUCT T2 
				ON T4.BASIC_PRODUCT_ID = T2.BASIC_PRODUCT_ID 
				LEFT JOIN T_BASIC_PRODUCT_STOCK T3
				ON T4.BASIC_PRODUCT_ID = T3.BASIC_PRODUCT_ID
				LEFT JOIN T_USER T5
				ON T1.USER_ID =  T5.USER_ID
			WHERE T1.INVT_PRODUCT_ID = #{invest_product_id} AND T4.BASIC_PRODUCT_ID = #{basic_product_id}
				AND (T6.INVEST_STATUS = '3' OR T6.INVEST_STATUS = '5')
	</select>
	<!--增加投资产品 -->
	<insert id="insertInvestProduct" parameterType="Map">
			INSERT INTO 
				T_INVEST_PRDOUCT
				(USER_ID,INVT_PRODUCT_NAME,RISK_LVL,INVT_PRODUCT_STATUS,
				STARTER_BAIL,INVESTER_BAIL,LAUNCHER_ACCRUEDCHARGES_TYPE,LAUNCHER_ACCRUEDCHARGES_AMOUNT,
				USER_ACCRUEDCHARGES_TYPE,USER_ACCRUEDCHARGES_AMOUNT,
				START_DATE,END_DATE,AMOUNT,PROTOL_ID,ISSUE_FEE,
				CREATE_DATE,UPDATE_DATE,IS_DEL)
			VALUES
				(#{user_id},#{invt_product_name},#{risk_lvl},#{invt_product_status},
				#{starter_bail},#{invester_bail},#{launcher_accruedcharges_type},#{launcher_accruedcharges_amount},
				#{user_accruedcharges_type},#{user_accruedcharges_amount},
				#{start_date},#{end_date},#{amount},#{protol_id},#{issue_fee},
				NOW(),NOW(),'0')
	</insert>
	<!-- 查询投资产品基本信息 -->
	<select id="selectInvtMoreInfoById" parameterType="string" resultType="InvestMoreInfo">
			SELECT
				INVT_PRODUCT_ID,USER_ID,INVT_PRODUCT_NAME,RISK_LVL,INVT_PRODUCT_STATUS,
				START_DATE,END_DATE,AMOUNT,PROTOL_ID,ISSUE_FEE,BASIC_INVEST_TYPE,
				STARTER_BAIL,INVESTER_BAIL,LAUNCHER_ACCRUEDCHARGES_TYPE,
				LAUNCHER_ACCRUEDCHARGES_AMOUNT,USER_ACCRUEDCHARGES_TYPE,
				USER_ACCRUEDCHARGES_AMOUNT,CREATE_DATE,UPDATE_DATE
			FROM T_INVEST_PRDOUCT
			WHERE 
				INVT_PRODUCT_ID = #{invest_product_id}
	</select>
	<!-- 增加投资-基础-关联关系 -->
	<insert id="insertInvestBase" parameterType="Map">
			INSERT INTO 
				T_INVEST_BASE(INVT_PRODUCT_ID,BASIC_PRODUCT_ID)
			VALUES
				(#{invt_product_id},#{basic_product_id})
	</insert>
	<!-- 删除投资产品 -->
	<update id="delInvestProduct" parameterType="Map">
			DELETE
			FROM
				T_INVEST_PRDOUCT
			WHERE
				INVT_PRODUCT_ID = #{invt_product_id}
	</update>
	<!-- 更新投资产品 -->
	<update id="updateInvestProduct" parameterType="Map">
			UPDATE
				T_INVEST_PRDOUCT
			SET
				INVT_PRODUCT_NAME = #{invt_product_name},RISK_LVL = #{risk_lvl},INVT_PRODUCT_STATUS = #{invt_product_status},
				START_DATE = #{start_date},END_DATE = #{end_date},AMOUNT = #{amount},PROTOL_ID = #{protol_id},
				STARTER_BAIL = #{starter_bail},INVESTER_BAIL = #{invester_bail} ,
				LAUNCHER_ACCRUEDCHARGES_TYPE = #{launcher_accruedcharges_type},LAUNCHER_ACCRUEDCHARGES_AMOUNT = #{launcher_accruedcharges_amount},
				USER_ACCRUEDCHARGES_TYPE = #{user_accruedcharges_type},USER_ACCRUEDCHARGES_AMOUNT = #{user_accruedcharges_amount},
				ISSUE_FEE = #{issue_fee},UPDATE_DATE = now()
			WHERE
				INVT_PRODUCT_ID = #{invt_product_id}
	</update>
	<!-- 更新投资产品状态 -->
	<update id="updateInvestProductStatus" parameterType="Map">
			UPDATE
				T_INVEST_PRDOUCT
			SET
				INVT_PRODUCT_STATUS = #{invt_product_status},
				UPDATE_DATE = now()
			WHERE
				INVT_PRODUCT_ID = #{invt_product_id}
	</update>
	<!-- 删除投资产品基础关联 -->
	<delete id="delInvestBase" parameterType="string">
			DELETE
			FROM
				T_INVEST_BASE
			WHERE
				INVT_PRODUCT_ID = #{invt_product_id}
	</delete>
	<!-- 查询产品投资收益率 -->
	<select id="selectInvestRate" resultType="string" parameterType="string">
		SELECT 
			100*SUM(USER_INVEST_PROFIT)/SUM(PRODUCT_BUYCOUNT_ALL) AS USER_INVEST_PROFIT
		FROM T_PRODUCT_SETTLEDETAIL
		WHERE INVT_PRODUCT_ID = #{invt_product_id} 
	</select>
	
	<!-- 查询产品中签数量 -->
	<select id="selectInvtLovCount" parameterType="string" resultType="int">
		SELECT COUNT(*) FROM T_INVEST_NOINFO
		WHERE
			INVEST_PRDOUCT_ID = #{invest_product_id} 
	</select>
	<!-- 查询产品总投资额 -->
	<select id="selectInvtCountAll" parameterType="string" resultType="string">
		SELECT SUM(ACOUNT_PRTFEEALL) FROM T_INVEST
		WHERE
			INVEST_PRDOUCT_ID = #{invest_product_id}  AND INVEST_STATUS != '1' AND INVEST_STATUS !='9'
	</select>
	
</mapper>